<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Set Theory Talks</title>
    <meta name="description" content="Global set theory seminar and conference announcements">
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/cutestrap@1.3.1/dist/css/cutestrap.min.css"
    />
    <style>
      .gmail_quote {
        display: none;
      }

      * + * {
        margin-top: 1em;
      }
      
      #posts {
        float: left;
      }
      
      #conferences {
        float: right;
        max-width: 10em;
      }
      
      #conferences a {
        display: block;
      }

      .post {
        margin: 1em auto;
        max-width: 35em;
        border: 0.5vmin solid lightgray;
        border-radius: 2%;
        padding: 1em;
      }

      .post__date {
        grid-column: 1;
        color: gray;
      }
      
      .post__date::before {
        content: 'Posted ';
      }
      
      .post__body {
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 50vh;
        overflow-y: auto;
      }

      .post__title {
      }

      .post__seminar {
        color: red;
      }

      .post__url {
        font-size: 0.8em;
        background-color: lightgray;
        width: max-content;
      }

      .post__url__link::before {
        content: '\1F517\ ';
      }

      .post__tags {
        font-size: 0.8em;
        color: gray;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Set Theory Talks</h1>
      <p>Global set theory seminar and conference announcements</p>
    </header>

    <div id="posts">
    </div>
    
    <aside id="conferences">
      <p>Upcoming conferences:</p>
    </aside>

    <noscript>I'm sorry, Dave, I'm afraid I can't do that. <br> You must have disabled JavaScript in your browser because nothing could ever fail in my programming. <br> -- Hal</noscript>
    
    <script src="https://cdn.jsdelivr.net/gh/mholt/PapaParse/papaparse.min.js"></script>
    <script>
      const json2post = item => {
        const post = document.createElement('div');
        const id = `${item[0]}${item[2]}`.hashCode();
        post.id = id;
        post.classList.add('post');
        document.getElementById("posts").append(post);

        const posttitle = document.createElement('h2');
        posttitle.classList.add('post__title');
        posttitle.innerHTML = item[2];
        post.appendChild(posttitle);
        
        const seminar = document.createElement('div');
        seminar.classList.add('post__seminar');
        seminar.innerHTML = item[1];
        post.appendChild(seminar);
        
        const postdate = document.createElement('div');
        postdate.classList.add('post__date');
        postdate.innerHTML = item[0];
        post.appendChild(postdate);
        
        const postbody = document.createElement('div');
        postbody.classList.add('post__body');
        postbody.innerHTML = item[3];
        post.appendChild(postbody);
        
        if (item[5] !== '') {
          const url = document.createElement('div');
          url.classList.add('post__url');
          url.innerHTML = `<a class="post__url__link" href="${item[5]}">Link to more info</a>`;
          post.appendChild(url);
        }
        
        if (item[4] !== '') {
          const tags = document.createElement('div');
          tags.classList.add('post__tags');
          tags.innerHTML = 'Tagged: ' + item[4];
          post.appendChild(tags);
        }
      };
      
      const json2conf = item => {
        if (item[6]) {
          eventdate = new Date(item[6]);
          today = new Date();
          if (eventdate >= today) {
            const a = document.createElement('a');
            a.innerHTML = item[2];
            const id = `${item[0]}${item[2]}`.hashCode();
            a.href = '#' + id;
            document.getElementById('conferences').append(a);
          }
        }
      };
      
      String.prototype.hashCode = function() {
        var hash = 0, i, chr;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
          chr   = this.charCodeAt(i);
          hash  = ((hash << 5) - hash) + chr;
          hash |= 0; // Convert to 32bit integer
        }
        return hash;
      };

      const SOURCE =
        'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGjzhmyqaGaXr0VrrgqPN98SN9lsbnqemQ2QDS-ILSce30ZPQb8AnmxiEX0piNaq88e3I6OTu1BOhC/pub?output=csv';

      fetch(SOURCE)
        .then(function(response) {
          return response.text();
        })
        .then(function(csv) {
          let json = Papa.parse(csv, { delimiter: ',' }).data;
          // console.log(Object.keys(json));
          // console.log(json, csv);
          json.shift();
          // console.log(json);
          for (let key of Object.keys(json)) {
            json2post(json[key]);
            json2conf(json[key]);
          }
        });
    </script>
  </body>
</html>
